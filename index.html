<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.2.0/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/ethjs@0.3.4/dist/ethjs.min.js"></script>
    <script src="https://cdn.bootcss.com/bignumber.js/6.0.0/bignumber.min.js"></script>
</head>

<body>
    <div class="container-fluid" id="cb">

        <div>
            <p>合约地址 {{ blockDebitAddress }}</p>
            <p>合约 owner {{ owner }}</p>
            <p>合约 owner USDT 余额 {{ ownerToken / 10**6 }} USDT</p>
            <p>合约 owner 当前允许借出 {{ ownerApprove / 10**6 }} USDT</p>
        </div>
        <hr>
        <div>
            <p>你的地址是: {{ user }}. 友情提示: 如果这里是 null, 请重新刷新页面</p>
            <p>目前有 {{currentETH / 10 ** 18}} 个以太, {{currentUSDT / 10 ** 6}} USDT</p>
            <p>你目前的借贷信息: 你抵押了{{ debitInfo[0].toString() / 10**18 }} 以太, 你应该还 {{ debitInfo[1].toString() / 10**6 }} USDT, 截止日期是
                {{ new Date(debitInfo[2].toNumber() * 1000) }}</p>
            <p>当前借贷兑出率: {{ exchangeRate / 10**4}} (每以太可借出 USDT)</p>
        </div>

        <div class="row">
            <input v-model="giveDebitEther" type="text" class="form-control" placeholder="666" aria-describedby="basic-addon1">
            <span class="input-group-addon" id="basic-addon2">Ether</span>
        </div>

        <div class="row">
            <input v-model="giveDebitDay" type="text" class="form-control" placeholder="666" aria-describedby="basic-addon1" v-on:change="updateDaysInterest">
            <span class="input-group-addon" id="basic-addon2">天, 利率是万分之{{ daysInterest }}</span>
        </div>

        <div class="row">
            <button class="btn btn-default" type="button" v-on:click="giveDebit">我要抵押</button>
        </div>

        <br>

        <div class="row">
            <button class="btn btn-default" type="button" v-on:click="backDebit1">我要还款1: 重置 USDT approve</button>
        </div>
        <div class="row">
            <button class="btn btn-default" type="button" v-on:click="backDebit2">我要还款2: 设置 USDT approve</button>
        </div>
        <div class="row">
            <button class="btn btn-default" type="button" v-on:click="backDebit3">我要还款3: 还款</button>
        </div>
    </div>

    <script type="text/javascript" src="./BlockDebit.js"></script>
    <script type="text/javascript" src="./TetherToken.js"></script>
    <script>
        if (typeof web3 == 'undefined') {
            alert('No web3? You should consider trying MetaMask!')
        }

        if (web3.eth.coinbase === null) {
            setTimeout(function(){
                location.reload();
            }, 3000)
        }

        web3.version.getNetwork(function (e, networkID) {
            TetherTokenAddress = TetherTokenJSON.networks[networkID].address;
            BlockDebitAddress = BlockDebitJSON.networks[networkID].address;

            console.log(TetherTokenAddress, BlockDebitAddress);
            console.log(web3.eth.coinbase)

            eth = new Eth(web3.currentProvider);

            const TetherTokenABI = TetherTokenJSON.abi
            const TetherToken = eth.contract(TetherTokenABI).at(TetherTokenAddress);

            const BlockDebitABI = BlockDebitJSON.abi
            const BlockDebit = eth.contract(BlockDebitABI).at(BlockDebitAddress);

            var cb = new Vue({
                el: '#cb',
                data: {
                    inited: false,
                    giveDebitEther: 1,
                    giveDebitDay: 7,
                    currentETH: 0,
                    currentUSDT: 0,
                    debitInfo: [new BigNumber(123.4567), new BigNumber(123.4567), new BigNumber(123.4567), new BigNumber(0), new BigNumber(0)],
                    exchangeRate: 0,
                    owner: 0,
                    ownerToken: 0,
                    ownerApprove: 0,
                    user: "",
                    daysInterest: 0,
                    blockDebitAddress: BlockDebitAddress,
                },
                methods: {
                    update: function () {
                        BlockDebit.owner().then(r => cb.owner = r[0]).then(function () {
                            TetherToken.balanceOf(cb.owner).then(r => cb.ownerToken = r[0].toNumber());
                        }).then(function () {
                            TetherToken.allowance(cb.owner, BlockDebitAddress).then(r => cb.ownerApprove = r[0].toNumber())
                        });

                        // ------------------------------------------------------------
                        cb.user = web3.eth.coinbase

                        // ------------------------------------------------------------
                        web3.eth.getBalance(web3.eth.coinbase, function (err, balance) {
                            if (err === null) {
                                cb.currentETH = balance.toNumber()
                            }
                        });
                        TetherToken.balanceOf(web3.eth.coinbase).then(r => cb.currentUSDT = r[0].toNumber());

                        // 借贷信息
                        BlockDebit.info(web3.eth.coinbase).then(r => cb.debitInfo = r[0])
                        // 当前借贷利率
                        BlockDebit.exchangeRate().then(r => cb.exchangeRate = r[0].toNumber())
                    },
                    updateDaysInterest: function () {
                        console.log('updateDaysInterest')

                        BlockDebit.getInterest(cb.giveDebitDay).then(function (r) {
                            web3.eth.getBlockNumber(function (err, n) {
                                if (n > r[0][1].toNumber()) {
                                    cb.daysInterest = r[0][2].toNumber()
                                } else {
                                    cb.daysInterest = r[0][0].toNumber()
                                }
                            })
                        })
                    },
                    giveDebit: function () {
                        BlockDebit.giveDebit(cb.giveDebitDay, {
                            'from': web3.eth.coinbase,
                            'value': web3.toWei(cb.giveDebitEther, 'ether'),
                            'gasLimit': 400000,
                        }).then(function () {
                            cb.update()
                        })
                    },
                    backDebit1: function () {
                        TetherToken.approve(BlockDebitAddress, 0, {
                            'from': web3.eth.coinbase
                        })
                    },
                    backDebit2: function () {
                        TetherToken.approve(BlockDebitAddress, cb.debitInfo[1], {
                            'from': web3.eth.coinbase
                        });
                    },
                    backDebit3: function () {
                        BlockDebit.backDebit({
                            'from': web3.eth.coinbase
                        })
                    }
                }
            })
            cb.update()
            cb.updateDaysInterest()
        })
    </script>
</body>

</html>
